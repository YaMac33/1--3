# 1--3

```md
# Google Form → マルチ生成パイプライン（GAS × Queue Architecture）

Google Form の送信をトリガーにして、  
**Webページ / ブログ記事 / スライド** など複数の成果物を自動生成するための  
**壊れにくく・再実行可能な Google Apps Script（GAS）プロジェクト**です。

本プロジェクトは **「フォーム送信＝即処理」ではなく  
「フォーム送信＝ジョブ登録」** という思想で設計されています。

---

## ✨ 特徴

- フォーム送信 1 回で **複数処理を並列実行**
- 失敗しても **キューに履歴が残る**
- 再実行・リトライが容易
- 処理追加（D / E / F …）が簡単
- 外部 API（生成AI / GitHub / WordPress 等）前提でも安定

---

## 🧠 アーキテクチャ概要

```
```

Google Form
↓
回答先スプレッドシート
↓（フォーム送信トリガー）
[ 親GAS ]
↓
_QUEUE（ジョブキュー）
↓
[A / B / C ワーカー（時間主導）]

```

### 採用方式：キュー分配型（方式2）
- トリガーは **1つだけ**
- 実処理はすべて **キュー基準**
- 並列処理・順序制御・再実行に強い構成

---

## 📦 構成要素

### 1. 親GAS（トリガー専用）
責務：
- Google Form の送信を検知
- A / B / C 用のジョブをキューに積む
- **処理は一切しない**

特徴：
- 軽量・安全
- フォーム送信失敗が起きにくい

---

### 2. ジョブキュー（`_QUEUE` シート）
すべての処理状態を管理する **唯一の真実の記録（SSOT）**

| 列名 | 内容 |
|---|---|
| jobId | ジョブ識別子 |
| createdAt | ジョブ作成時刻 |
| jobType | A_HTML_GITHUB / B_BLOG_WP / C_SLIDES_GEN |
| status | PENDING / RUNNING / DONE / ERROR |
| sourceSheet | フォーム回答シート名 |
| sourceRow | 回答行番号 |
| payloadJson | 回答データ（JSON） |
| retryCount | 再試行回数 |
| lastError | エラー内容 |
| updatedAt | 最終更新時刻 |

---
```

### 3. ワーカーGAS（A / B / C）
- 時間主導トリガー（例：1分毎）
- `status = PENDING` の自分の jobType のみ処理
- 状態遷移：
```

PENDING → RUNNING → DONE
↘ ERROR

````

---

## 🔧 想定されるジョブ例

| jobType | 内容 |
|---|---|
| A_HTML_GITHUB | HTML/CSS/JS生成 → GitHub Pages 反映 |
| B_BLOG_WP | 記事生成 → WordPress 投稿 |
| C_SLIDES_GEN | Google Slides 自動生成 |

---

## 🚀 セットアップ手順

### 1. スプレッドシートを用意
- Google Form の回答先スプレッドシートを作成
- スプレッドシートIDを控える

### 2. 親GASを設定
- スプレッドシートに紐づくGASを作成
- 親トリガーコードを貼り付け
- `CONFIG.SPREADSHEET_ID` を設定

### 3. 初期化（初回のみ）
```js
initQueueAndTrigger();
````

* `_QUEUE` シートが作成される
* フォーム送信トリガーが自動設定される

---

## 🔐 安全設計ポイント

* `LockService.getDocumentLock()` による排他制御
* トリガー処理は軽量
* 実処理はすべてワーカー側
* APIキーは **Script Properties** 管理

---

## 🧩 設計思想（重要）

* フォーム送信は **イベント**
* 処理は **状態遷移**
* キューは **履歴であり制御点**

> 「今なにが起きているか」「どこで失敗したか」は
> すべて `_QUEUE` を見れば分かる。

---

## 🛠 今後の拡張予定

* ワーカー雛形の実装
* リトライ制御
* エラー通知（Slack / Mail）
* 処理依存関係（例：C → B → A）
* 実行制限・レート制御

---

## 🧭 このリポジトリを触る人へ

* 親GASは **絶対に重くしない**
* 新しい処理は **jobType を追加するだけ**
* 直接フォームトリガーで処理しない
* `_QUEUE` がこのシステムの心臓

---

## 📌 まとめ

このプロジェクトは
**「自動化を“安全に量産する”ための土台」**です。

* 壊れない
* 追える
* 増やせる

そのための最小構成として設計されています。
